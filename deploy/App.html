<!DOCTYPE html>
<html>
<head>
    <title>Random App Name38901</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"pulldown-container",layout:{type:"hbox",align:"stretch",padding:"5"}}],StoryMapBoard:void 0,launch:function(){console.log("Hello world! I am the decomp stry progress viewer in v0.1 change 2"),me=this,me._loadIterations(),console.log("iterations loaded")},_loadIterations:function(){console.log("called _loadIterations");var e=Ext.create("Rally.ui.combobox.IterationComboBox",{itemId:"iteration-combobox",fieldLabel:"Start from:",labelAlign:"right",width:500,listeners:{ready:this._loadSchedules,select:this._loadData,scope:this}});this.down("#pulldown-container").add(e)},_loadSchedules:function(){console.log("called _loadSchedules"),me=this,me.down("#pulldown-container").add({xtype:"rallyfieldvaluecombobox",itemId:"state-combobox",model:"UserStory",multiSelect:!0,field:"ScheduleState",value:["Defined","Backlog","In-Progress","Completed"],fieldLabel:"Schedule State",labelAlign:"right",listeners:{select:me._loadData,ready:me._loadTags,scope:me}})},_loadTags:function(){console.log("called _loadTags"),me=this,me.down("#pulldown-container").add({xtype:"rallytagpicker",itemId:"tag-picker",width:400,fieldLabel:"Tags:",labelAlign:"right",autoExpand:!1,listeners:{select:me._loadData,boxready:me._loadEpics,scope:me}})},_loadEpics:function(){console.log("called _loadEpics"),me=this,me.down("#pulldown-container").add({xtype:"rallyartifactsearchcombobox",storeConfig:{models:["portfolioitem/epic"]},itemId:"epic-combobox",defaultSelectionPosition:"first",allowClear:!0,fieldLabel:"Epic drilldown:",labelAlign:"right",listeners:{select:me._loadData,boxready:me._loadHideCheck,scope:me}})},_loadHideCheck:function(){console.log("called _loadHideCheck");this.down("#pulldown-container").add({xtype:"rallycheckboxfield",boxLabel:"Show empty iterations",itemId:"hidecheckbox",value:!0,width:300,padding:"0 0 0 30",listeners:{change:this._loadData,added:this._loadData,scope:this}})},_getFilters:function(e,o,t,a){console.log("called getfilters");var l=void 0,i=void 0,r=void 0;e.forEach(function(e){i=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operation:"=",value:e}),l=l?l.or(i):i});var d=me.down("#iteration-combobox").getRecord().data.StartDate.toISOString(),n=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.StartDate",operator:">=",value:d}).or(Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",operator:"=",value:null}));if(l=l.and(n),console.log("tags is",a),a.length>0&&(_.each(a,function(e){r=r?r.or(Ext.create("Rally.data.wsapi.Filter",{property:"Tags",operator:"=",value:e.data._ref})):Ext.create("Rally.data.wsapi.Filter",{property:"Tags",operator:"=",value:e.data._ref})}),l=l.and(r)),console.log("did tags filter"),console.log("epic Value is ",t),""!=t){var s=Ext.create("Rally.data.wsapi.Filter",{property:"PortfolioItem",operator:"=",value:t});s=s.or(Ext.create("Rally.data.wsapi.Filter",{property:"Parent.PortfolioItem",operator:"=",value:t})),l=l.and(s)}return l=l.and(Ext.create("Rally.data.wsapi.Filter",{property:"DirectChildrenCount",operator:"=",value:0}))},_hideEmptyColumns(e){console.log("entering hide empty");var o=this.down("#hidecheckbox").getValue(),t=this.down("#iteration-combobox").getRecord().get("Name"),a=!0;_.each(e,function(e){var l=e.getCards(),i=_.flatten(_.values(l)).length;e.getColumnHeaderConfig().headerTpl===t&&(a=!1),a&&"None"!=e.getColumnHeaderConfig().headerTpl||0===i&&!o?(console.log("hiding",e," because ","before selected iter:",a,"the header is ",e.getColumnHeaderConfig().headerTpl,"cardcount is ",i,"showempty is",o),e.setVisible(!1)):e.setVisible(!0)}),console.log("leaving hide empty")},_onBoardLoaded:function(e,o){this._hideEmptyColumns(e.getColumns())},_loadData:function(){me=this,console.log(me.down("#tag-picker").selectedValues.items);var e=me._getFilters(me.down("#state-combobox").getValue(),me.down("#iteration-combobox").getRecord().get("_ref"),me.down("#epic-combobox").getValue(),me.down("#tag-picker").selectedValues.items),o=me.down("#epic-combobox").getValue(),t="Epic",a=["Name","Parent","ScheduleState","PlanEstimate"];e?(""!=o&&null!=o&&(console.log("setting parent",o),t="Parent",a=["Name","ScheduleState","PlanEstimate"]),me.StoryMapBoard?me.StoryMapBoard.refresh({storeConfig:{filters:e},rowConfig:{field:t}}):(me.StoryMapBoard=Ext.create("Rally.ui.cardboard.CardBoard",{types:["User Story"],attribute:"Iteration",rowConfig:{field:t},cardConfig:{fields:a},listeners:{load:me._onBoardLoaded,scope:me},storeConfig:{filters:e,context:{projectScopeUp:!1,projectScopeDown:!0}}}),me.add(me.StoryMapBoard)),console.log("board config is ",me.StoryMapBoard.getStoreConfig()),console.log("context is ",this.getContext())):console.log("No states selected")}});

            Rally.launchApp('CustomApp', {
                name:"Random App Name38901",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
