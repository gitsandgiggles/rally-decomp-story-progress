<!DOCTYPE html>
<html>
<head>
    <title>Random App Name38901</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"pulldown-container",layout:{type:"hbox",align:"stretch",padding:"5"}}],EpicSelectorInit:!1,StoryMapBoard:void 0,launch:function(){console.log("Hello world! I am the decomp stry progress viewer in v0.1 change 2"),me=this,me._loadIterations(),console.log("iterations loaded")},_loadIterations:function(){console.log("called _loadIterations");var e=Ext.create("Rally.ui.combobox.IterationComboBox",{itemId:"iteration-combobox",fieldLabel:"Start from:",labelAlign:"right",width:500,listeners:{ready:this._loadSchedules,select:this._loadData,scope:this},storeConfig:{context:{projectScopeDown:!0}}});this.down("#pulldown-container").add(e)},_loadSchedules:function(){console.log("called _loadSchedules"),me=this,me.down("#pulldown-container").add({xtype:"rallyfieldvaluecombobox",itemId:"state-combobox",model:"UserStory",multiSelect:!0,field:"ScheduleState",value:["Defined","Backlog","In-Progress","Completed"],fieldLabel:"Schedule State",labelAlign:"right",listeners:{select:me._loadData,ready:me._loadTags,scope:me}})},_loadTags:function(){console.log("called _loadTags"),me=this,me.down("#pulldown-container").add({xtype:"rallytagpicker",itemId:"tag-picker",width:400,fieldLabel:"Tags:",labelAlign:"right",autoExpand:!1,listeners:{select:me._loadData,selectionchange:me._loadData,boxready:me._loadEpics,scope:me}})},_loadEpics:function(){console.log("called _loadEpics"),me=this,me.down("#pulldown-container").add({xtype:"rallyartifactsearchcombobox",storeConfig:{models:["portfolioitem/epic"]},itemId:"epic-combobox",allowClear:!0,fieldLabel:"Epic drilldown:",labelAlign:"right",listeners:{select:me._selectEpicHelper,boxready:me._loadHideCheck,scope:me}})},_selectEpicHelper:function(){this.EpicSelectorInit=!0,this._loadData()},_loadHideCheck:function(){console.log("called _loadHideCheck");this.down("#pulldown-container").add({xtype:"rallycheckboxfield",boxLabel:"Show empty iterations",itemId:"hidecheckbox",value:!0,width:200,padding:"0 0 0 30",listeners:{change:this._loadData,added:this._uiButtons,scope:this}})},_uiButtons:function(){var e=this;e.down("#pulldown-container").add({xtype:"rallybutton",itemId:"collapseallbutton",text:"Collapse All",handler:function(){e._doCollapse("collapse")},scope:e}),e.down("#pulldown-container").add({xtype:"rallybutton",itemId:"expandallbutton",text:"Expand All",handler:function(){e._doCollapse("expand")},scope:e}),e._loadData()},_getFilters:function(e,o,t,l){console.log("##############epic is",t);var a=void 0;return a=(a=me._getStateFilter(e)).and(me._getIterFilter(o)),""!=t&&(a=a.and(me._getEpicFilter(t))),l.length>0&&(a=a.and(me._getTagFilter(l))),a=a.and(me._getParentFilter())},_getStateFilter:function(e){var o=void 0,t=void 0;return e.forEach(function(e){t=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operation:"=",value:e}),o=o?o.or(t):t}),o},_getIterFilter:function(e){var o=me.down("#iteration-combobox").getRecord().data.StartDate.toISOString();return Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.StartDate",operator:">=",value:o}).or(Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",operator:"=",value:null}))},_getEpicFilter:function(e){if(console.log("epic Value is ",e),""!=e)return console.log("shoudl be searching for ",e),epicFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Epic",operator:"=",value:e}),console.log("epic filter is ",epicFilter),epicFilter},_getTagFilter:function(e){var o=void 0;return console.log("tags is",e),e.length>0&&_.each(e,function(e){o=o?o.or(Ext.create("Rally.data.wsapi.Filter",{property:"Tags",operator:"=",value:e.data._ref})):Ext.create("Rally.data.wsapi.Filter",{property:"Tags",operator:"=",value:e.data._ref})}),o},_getParentFilter:()=>Ext.create("Rally.data.wsapi.Filter",{property:"DirectChildrenCount",operator:"=",value:0}),_hideEmptyColumns(){console.log("entering hide empty");var e=this.down("#progressboard").getColumns(),o=this.down("#hidecheckbox").getValue(),t=this.down("#iteration-combobox").getRecord().get("Name"),l=!0;_.each(e,function(e){var a=e.getCards(),i=_.flatten(_.values(a)).length;e.getColumnHeaderConfig().headerTpl===t&&(l=!1),l&&"None"!=e.getColumnHeaderConfig().headerTpl||0===i&&!o?(console.log("hiding",e," because ","before selected iter:",l,"the header is ",e.getColumnHeaderConfig().headerTpl,"cardcount is ",i,"showempty is",o),e.setVisible(!1)):e.setVisible(!0)}),console.log("leaving hide empty")},_doCollapse(e){var o=me.down("#progressboard").getRows();"collapse"==e?me._collapseAll(o):"expand"==e&&me._expandAll(o)},_collapseAll(e){console.log("in collapse"),_.each(e,function(e){e.collapse()})},_expandAll(e){console.log("in expand"),_.each(e,function(e){e.expand()})},_onBoardLoaded:function(e,o){this._hideEmptyColumns(),this._doCollapse("expand")},_loadData:function(){me=this,console.log(me.down("#tag-picker").selectedValues.items);var e=me.EpicSelectorInit?me.down("#epic-combobox").getValue():"",o=me._getFilters(me.down("#state-combobox").getValue(),me.down("#iteration-combobox").getRecord().get("_ref"),e,me.down("#tag-picker").selectedValues.items),t="Epic",l=["Name","Parent","ScheduleState","PlanEstimate"];o?(""!=e&&(console.log("setting parent",e),t="Parent",l=["Name","ScheduleState","PlanEstimate"],console.log("shouldnt see parent in the card")),console.log("fieldlist is ",l),me.StoryMapBoard?me.StoryMapBoard.refresh({storeConfig:{filters:o},rowConfig:{field:t},cardConfig:{fields:l}}):(me.StoryMapBoard=Ext.create("Rally.ui.cardboard.CardBoard",{types:["User Story"],attribute:"Iteration",itemId:"progressboard",rowConfig:{field:t},cardConfig:{fields:l},listeners:{load:me._onBoardLoaded,scope:me},storeConfig:{filters:o,context:{projectScopeUp:!1,projectScopeDown:!0}}}),me.add(me.StoryMapBoard)),console.log("board config is ",me.StoryMapBoard.getStoreConfig()),console.log("context is ",this.getContext())):console.log("No states selected")}});

            Rally.launchApp('CustomApp', {
                name:"Random App Name38901",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
