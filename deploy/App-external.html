<!DOCTYPE html>
<html>
<head>
    <title>Random App Name38901</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"pulldown-container",layout:{type:"hbox",align:"stretch",padding:"5"}}],EpicSelectorInit:!1,StoryMapBoard:void 0,launch:function(){console.log("Hello world! I am the decomp stry progress viewer in v0.1 change 2"),me=this,me._loadIterations(),console.log("iterations loaded")},_loadIterations:function(){console.log("called _loadIterations");var e=Ext.create("Rally.ui.combobox.IterationComboBox",{itemId:"iteration-combobox",fieldLabel:"Start from:",labelAlign:"right",width:500,listeners:{ready:this._loadSchedules,select:this._loadData,scope:this},storeConfig:{context:{projectScopeDown:!0}}});this.down("#pulldown-container").add(e)},_loadSchedules:function(){console.log("called _loadSchedules"),me=this,me.down("#pulldown-container").add({xtype:"rallyfieldvaluecombobox",itemId:"state-combobox",model:"UserStory",multiSelect:!0,field:"ScheduleState",value:["Defined","Backlog","In-Progress","Completed"],fieldLabel:"Schedule State",labelAlign:"right",listeners:{select:me._loadData,ready:me._loadTags,scope:me}})},_loadTags:function(){console.log("called _loadTags"),me=this,me.down("#pulldown-container").add({xtype:"rallytagpicker",itemId:"tag-picker",width:400,fieldLabel:"Tags:",labelAlign:"right",autoExpand:!1,listeners:{select:me._loadData,selectionchange:me._loadData,boxready:me._loadEpics,scope:me}})},_loadEpics:function(){console.log("called _loadEpics"),me=this,me.down("#pulldown-container").add({xtype:"rallyartifactsearchcombobox",storeConfig:{models:["portfolioitem/epic"]},itemId:"epic-combobox",allowClear:!0,fieldLabel:"Epic drilldown:",labelAlign:"right",listeners:{select:me._selectEpicHelper,boxready:me._loadHideCheck,scope:me}})},_selectEpicHelper:function(){this.EpicSelectorInit=!0,this._loadData()},_loadHideCheck:function(){console.log("called _loadHideCheck");this.down("#pulldown-container").add({xtype:"rallycheckboxfield",boxLabel:"Show empty iterations",itemId:"hidecheckbox",value:!0,width:200,padding:"0 0 0 30",listeners:{change:this._loadData,added:this._uiButtons,scope:this}})},_uiButtons:function(){var e=this;e.down("#pulldown-container").add({xtype:"rallybutton",itemId:"collapseallbutton",text:"Collapse All",handler:function(){e._doCollapse("collapse")},scope:e}),e.down("#pulldown-container").add({xtype:"rallybutton",itemId:"expandallbutton",text:"Expand All",handler:function(){e._doCollapse("expand")},scope:e}),e._loadData()},_getFilters:function(e,t,o,a){console.log("##############epic is",o);var l=void 0;return l=(l=me._getStateFilter(e)).and(me._getIterFilter(t)),""!=o&&(l=l.and(me._getEpicFilter(o))),a.length>0&&(l=l.and(me._getTagFilter(a))),l=(l=l.and(me._getParentFilter())).and(me._getKanBanFilter())},_getStateFilter:function(e){var t=void 0,o=void 0;return e.forEach(function(e){o=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operation:"=",value:e}),t=t?t.or(o):o}),t},_getIterFilter:function(e){var t=me.down("#iteration-combobox").getRecord().data.StartDate.toISOString();return Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.StartDate",operator:">=",value:t}).or(Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",operator:"=",value:null}))},_getEpicFilter:function(e){if(console.log("epic Value is ",e),""!=e)return console.log("shoudl be searching for ",e),epicFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Epic",operator:"=",value:e}),console.log("epic filter is ",epicFilter),epicFilter},_getTagFilter:function(e){var t=void 0;return console.log("tags is",e),e.length>0&&_.each(e,function(e){t=t?t.or(Ext.create("Rally.data.wsapi.Filter",{property:"Tags",operator:"=",value:e.data._ref})):Ext.create("Rally.data.wsapi.Filter",{property:"Tags",operator:"=",value:e.data._ref})}),t},_getParentFilter:()=>Ext.create("Rally.data.wsapi.Filter",{property:"DirectChildrenCount",operator:"=",value:0}),_getKanBanFilter:()=>Ext.create("Rally.data.wsapi.Filter",{property:"Tags.Name",operator:"!=",value:"KanBan"}),_hideEmptyColumns(){console.log("entering hide empty");var e=this.down("#progressboard").getColumns(),t=this.down("#hidecheckbox").getValue(),o=this.down("#iteration-combobox").getRecord().get("Name"),a=!0;_.each(e,function(e){var l=e.getCards(),i=_.flatten(_.values(l)).length;e.getColumnHeaderConfig().headerTpl===o&&(a=!1),a&&"None"!=e.getColumnHeaderConfig().headerTpl||0===i&&!t?(console.log("hiding",e," because ","before selected iter:",a,"the header is ",e.getColumnHeaderConfig().headerTpl,"cardcount is ",i,"showempty is",t),e.setVisible(!1)):e.setVisible(!0)}),console.log("leaving hide empty")},_doCollapse(e){var t=me.down("#progressboard").getRows();"collapse"==e?me._collapseAll(t):"expand"==e&&me._expandAll(t)},_collapseAll(e){console.log("in collapse"),_.each(e,function(e){e.collapse()})},_expandAll(e){console.log("in expand"),_.each(e,function(e){e.expand()})},_onBoardLoaded:function(e,t){this._hideEmptyColumns(),this._doCollapse("expand")},_loadData:function(){me=this,console.log(me.down("#tag-picker").selectedValues.items);var e=me.EpicSelectorInit?me.down("#epic-combobox").getValue():"",t=me._getFilters(me.down("#state-combobox").getValue(),me.down("#iteration-combobox").getRecord().get("_ref"),e,me.down("#tag-picker").selectedValues.items),o="Epic",a=["Name","Parent","ScheduleState","PlanEstimate"];t?(""!=e&&(console.log("setting parent",e),o="Parent",a=["Name","ScheduleState","PlanEstimate"],console.log("shouldnt see parent in the card")),console.log("fieldlist is ",a),me.StoryMapBoard?me.StoryMapBoard.refresh({storeConfig:{filters:t},rowConfig:{field:o},cardConfig:{fields:a}}):(me.StoryMapBoard=Ext.create("Rally.ui.cardboard.CardBoard",{types:["User Story"],attribute:"Iteration",itemId:"progressboard",rowConfig:{field:o},cardConfig:{fields:a},listeners:{load:me._onBoardLoaded,scope:me},storeConfig:{filters:t,context:{projectScopeUp:!1,projectScopeDown:!0}}}),me.add(me.StoryMapBoard)),console.log("board config is ",me.StoryMapBoard.getStoreConfig()),console.log("context is ",this.getContext())):console.log("No states selected")}});

            Rally.launchApp('CustomApp', {
                name:"Random App Name38901",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
